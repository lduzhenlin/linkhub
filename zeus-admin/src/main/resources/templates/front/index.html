<!DOCTYPE html>
<html lang="zh-CN" class="dark" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkHub</title>
  <!--  <script src="https://cdn.tailwindcss.com"></script>-->
  <script src="/js/tailwindcss-4.1.10.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <!-- 消息弹框 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <!-- SortableJS for drag and drop -->
<!--  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>-->
  <script src="/js/Sortable.min.js"></script>
  <style>
    :root {
      --bg-dark: #1a1b1e;
      --bg-card-dark: #25262b;
      --bg-light: #f1f3f4;
      --bg-card-light: #ffffff;
    }
    
    /* 暗色模式 */
    .dark {
      color-scheme: dark;
    }
    .dark .bg-theme {
      background-color: var(--bg-dark);
    }
    .dark .bg-card-theme {
      background-color: var(--bg-card-dark);
    }
    .dark .border-theme {
      border-color: #2c2d31;
    }
    .dark .text-theme {
      color: #e5e5e5;
    }
    .dark .text-theme-secondary {
      color: #a1a1aa;
    }
    
    /* 浅色模式 */
    .light .bg-theme {
      background-color: var(--bg-light);
    }
    .light .bg-card-theme {
      background-color: var(--bg-card-light);
      border: 1px solid #e5e7eb;
    }
    .light .border-theme {
      border-color: #d1d5db;
    }
    .light .text-theme {
      color: #1f2937;
    }
    .light .text-theme-secondary {
      color: #6b7280;
    }

    /* 卡片阴影 */
    .light .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.08);
    }
    
    /* 深色主题阴影 */
    .dark .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }

    /* 移动端导航菜单 */
    @media (max-width: 768px) {
      .mobile-menu {
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
      }
      .mobile-menu.active {
        transform: translateX(0);
      }
    }

    /* 主题切换图标样式 */
    .dark .fa-moon {
      display: inline-block !important;
    }
    .dark .fa-sun {
      display: none !important;
    }
    .light .fa-moon {
      display: none !important;
    }
    .light .fa-sun {
      display: inline-block !important;
    }

    /* 拖拽排序样式 */
    .sortable-ghost {
      opacity: 0.4;
      background: var(--bg-card-dark);
    }
    .sortable-drag {
      opacity: 0.8;
    }
    .link-card {
      cursor: move;
      cursor: grab;
    }
    .link-card:active {
      cursor: grabbing;
    }

  </style>
</head>
<body class="bg-theme text-theme min-h-screen transition-colors duration-200">
  <div class="min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-theme border-b border-theme">
      <div class="container mx-auto px-4 sm:px-6 py-3">
        <div class="flex items-center justify-between">
          <!-- 移动端菜单按钮 -->
          <button id="mobileMenuBtn" class="lg:hidden text-theme-secondary hover:text-purple-500 transition-colors">
            <i class="fas fa-bars text-xl"></i>
          </button>
          
          <div class="flex items-center space-x-3">
            <h1 class="text-xl font-bold text-purple-500">LinkHub</h1>
            <span class="text-theme-secondary hidden sm:inline">|</span>
            <span class="text-theme-secondary text-sm hidden sm:inline">高效导航集成平台</span>
          </div>
          
          <div class="flex items-center space-x-4">
            <!-- 搜索框 - 在移动端隐藏 -->
            <div class="relative hidden md:block">
              <input type="text" id="searchInput" placeholder="搜索链接..."
                class="w-80 px-4 py-1.5 pl-10 bg-card-theme rounded text-theme border border-theme focus:outline-none focus:border-purple-500 transition-colors duration-200">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-theme-secondary"></i>
            </div>
            
            <div class="flex items-center space-x-4">
              <button id="themeToggle" class="text-theme-secondary hover:text-purple-500 transition-colors" title="切换主题">
                <i class="fas fa-moon hidden"></i>
                <i class="fas fa-sun"></i>
              </button>
              <div class="h-4 w-px bg-theme-secondary opacity-20 hidden sm:block"></div>
              <button class="px-4 py-1.5 bg-purple-500 hover:bg-purple-600 text-white rounded text-sm transition-colors" id="loginBtn">
                登录
              </button>
              <span id="userInfo" class="hidden text-theme-secondary text-sm cursor-pointer select-none">
                <i class="fas fa-user mr-1"></i><span id="usernameDisplay"></span>
                <button id="logoutBtn" onclick="handleLogout()" class="ml-2 text-xs text-purple-500 hover:text-purple-400">退出</button>
              </span>
            </div>
          </div>
        </div>
        
        <!-- 移动端搜索框 -->
        <div class="mt-3 md:hidden">
          <div class="relative">
            <input type="text" id="mobileSearchInput" placeholder="搜索链接..."
              class="w-full px-4 py-2 pl-10 bg-card-theme rounded text-theme border border-theme focus:outline-none focus:border-purple-500 transition-colors duration-200">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-theme-secondary"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- 移动端导航菜单 -->
    <div id="mobileMenu" class="mobile-menu fixed inset-y-0 left-0 w-64 bg-card-theme z-50 md:hidden">
      <div class="p-4 border-b border-theme">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-medium text-theme">导航菜单</h2>
          <button id="closeMobileMenu" class="text-theme-secondary hover:text-theme transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div id="mobileNavList" class="p-4 space-y-2">
        <!-- 移动端分类列表将通过 JavaScript 动态生成 -->
      </div>
    </div>

    <!-- 分类导航 - 在移动端隐藏 -->
    <nav class="bg-theme sticky top-0 z-10 border-b border-theme block">
      <div class="container mx-auto px-6 py-2">
        <div id="navList" class="flex items-center space-x-2 overflow-x-auto">
          <!-- 分类列表将通过 JavaScript 动态生成 -->
        </div>
      </div>
    </nav>

    <!-- 主要内容区 -->
    <main class="flex-1 container mx-auto px-4 sm:px-6 py-6">
      <div id="linkList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <!-- 工具卡片  有js动态生成-->

      </div>
    </main>
  </div>

  <!-- 悬浮按钮 - 在移动端调整位置 -->
  <div id="floatBtn" class="fixed right-4 bottom-4 sm:right-6 sm:bottom-6 flex flex-col space-y-3 hidden">
    <button onclick="openLinkSaveModal(null)" class="w-12 h-12 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center transition-colors" title="添加书签">
      <i class="fas fa-plus"></i>
    </button>
    <button onclick="openSaveCategoryModal()" class="w-12 h-12 bg-purple-500 hover:bg-purple-600 text-white rounded-full shadow-lg flex items-center justify-center transition-colors" title="分类管理">
      <i class="fas fa-tags"></i>
    </button>
  </div>

  <!-- 登录弹框 -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[480px] max-w-[95%] relative">
      <div class="p-8">
        <!-- 标题和关闭按钮 -->
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-xl font-medium text-theme">欢迎登录</h2>
          <button onclick="closeLoginModal()" class="text-theme-secondary hover:text-theme transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- 登录表单 -->
        <form id="loginForm" class="space-y-6">
          <div>
            <label class="block text-sm text-theme-secondary mb-2">账号</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-user text-theme-secondary"></i>
              </div>
              <input id="loginTel" type="tel"  class="w-full pl-10 pr-4 py-2.5 bg-theme border border-theme rounded-md text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入手机号">
            </div>
          </div>
          <div>
            <label class="block text-sm text-theme-secondary mb-2">密码</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-lock text-theme-secondary"></i>
              </div>
              <input id="loginPassword" type="password"  class="w-full pl-10 pr-4 py-2.5 bg-theme border border-theme rounded-md text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入密码">
              <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-theme-secondary hover:text-theme transition-colors" onclick="togglePassword(this)">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <label class="flex items-center space-x-2 cursor-pointer select-none">
              <input id="loginRemember" type="checkbox" checked class="w-4 h-4 bg-theme border-theme rounded text-purple-500 focus:ring-0 focus:ring-offset-0">
              <span class="text-sm text-theme-secondary">记住我</span>
            </label>
            <button type="button" onclick="openForgotPasswordModal()" class="text-sm text-purple-500 hover:text-purple-400 transition-colors">忘记密码？</button>
          </div>
          <button type="button" onclick="handleLogin()" class="w-full py-2.5 bg-purple-500 hover:bg-purple-600 text-white text-sm font-medium rounded-md transition-colors">
            登录
          </button>
          <div class="text-center">
            <span class="text-sm text-theme-secondary">还没有账号？</span>
            <button type="button" onclick="openRegisterModal()" class="text-sm text-purple-500 hover:text-purple-400 transition-colors ml-1">立即注册</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 注册弹框 -->
  <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[480px] relative">
      <div class="p-8">
        <!-- 标题和关闭按钮 -->
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-xl font-medium text-theme">注册账号</h2>
          <button onclick="closeRegisterModal()" class="text-theme-secondary hover:text-theme transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- 注册表单 -->
        <form id="registerForm" class="space-y-6">
          <div>
            <label class="block text-sm text-theme-secondary mb-2">手机号</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-phone text-theme-secondary"></i>
              </div>
              <input type="tel" id="registerTel" class="w-full pl-10 pr-4 py-2.5 bg-theme border border-theme rounded-md text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入手机号">
            </div>
          </div>
          <div>
            <label class="block text-sm text-theme-secondary mb-2">验证码</label>
            <div class="flex items-center space-x-2">
              <input type="text" id="registerCode" class="flex-1 px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入验证码">
              <button type="button" id="sendRegisterCodeBtn" onclick="sendRegisterCode()" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white text-sm rounded transition-colors">发送验证码</button>
            </div>
          </div>
          <div>
            <label class="block text-sm text-theme-secondary mb-2">密码</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-lock text-theme-secondary"></i>
              </div>
              <input type="password" id="registerPassword" class="w-full pl-10 pr-4 py-2.5 bg-theme border border-theme rounded-md text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入密码">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-theme-secondary hover:text-theme transition-colors" onclick="togglePassword(this)">
                  <i class="fas fa-eye"></i>
                </button>
              </input>
            </div>
          </div>
          <div>
            <label class="block text-sm text-theme-secondary mb-2">确认密码</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-lock text-theme-secondary"></i>
              </div>
              <input type="password" id="registerConfirmPassword" class="w-full pl-10 pr-4 py-2.5 bg-theme border border-theme rounded-md text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请再次输入密码">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-theme-secondary hover:text-theme transition-colors" onclick="togglePassword(this)">
                  <i class="fas fa-eye"></i>
                </button>
              </input>
            </div>
          </div>
          <div class="flex items-start space-x-2">
            <input id="registerAgreement" type="checkbox" class="mt-1 w-4 h-4 bg-theme border-theme rounded text-purple-500 focus:ring-0 focus:ring-offset-0">
            <span class="text-sm text-theme-secondary">我已阅读并同意 <a href="#" class="text-purple-500 hover:text-purple-400">服务条款</a> 和 <a href="#" class="text-purple-500 hover:text-purple-400">隐私政策</a></span>
          </div>
          <button type="button" onclick="handleRegister()" class="w-full py-2.5 bg-purple-500 hover:bg-purple-600 text-white text-sm font-medium rounded-md transition-colors">
            注册
          </button>
          <div class="text-center">
            <span class="text-sm text-theme-secondary">已有账号？</span>
            <button type="button" onclick="switchToLogin()" class="text-sm text-purple-500 hover:text-purple-400 transition-colors ml-1">立即登录</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 找回密码弹框 -->
  <div id="forgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[400px] relative">
      <div class="p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-medium text-theme">找回密码</h2>
          <button onclick="closeForgotPasswordModal()" class="text-theme-secondary hover:text-theme transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="forgotPasswordForm" class="space-y-6">
          <div>
            <label class="block text-sm text-theme-secondary mb-2">手机号</label>
            <input type="text" id="forgotPhone" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入手机号">
          </div>
          <div>
            <label class="block text-sm text-theme-secondary mb-2">验证码</label>
            <div class="flex items-center space-x-2">
              <input type="text" id="forgotCode" class="flex-1 px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入验证码">
              <button type="button" id="sendForgotCodeBtn" onclick="sendForgotCode()" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white text-sm rounded transition-colors">发送验证码</button>
            </div>
          </div>
          <div class="relative">
            <label class="block text-sm text-theme-secondary mb-2">新密码</label>
            <input type="password" id="forgotNewPassword"class="w-full px-3 py-2 h-10 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入新密码">
            <button type="button" class="absolute right-0 pr-3  h-10 text-theme-secondary hover:text-theme transition-colors" onclick="togglePassword(this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <button type="button" onclick="handleForgotPassword()" class="w-full py-2.5 bg-purple-500 hover:bg-purple-600 text-white text-sm font-medium rounded-md transition-colors">
            重置密码
          </button>
        </form>
      </div>
    </div>
  </div>

  <div id="saveLinkModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[480px] relative">
      <div class="p-4 border-b border-theme flex justify-between items-center">
        <h2 class="text-base font-medium text-theme">保存书签</h2>
        <button onclick="closeLinkSaveModal()" class="text-theme-secondary hover:text-theme transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="saveLinkForm" class="p-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-theme mb-1">名称</label>
            <input type="text" id="saveLinkTitle" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入书签名称">
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">链接</label>
            <input type="url" id="saveLinkUrl" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入链接地址">
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">描述</label>
            <textarea id="saveLinkDescription" rows="3" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors resize-none" placeholder="请输入书签描述"></textarea>
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">分类</label>
            <select id="saveLinkCategoryId" class="linkCategoryId w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors appearance-none"></select>
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">图标</label>
            <div class="flex items-center space-x-2">
              <div  class="w-8 h-8 bg-theme rounded flex items-center justify-center">
                <img id="saveLinkPreviewIcon" src="" alt="" class="w-4 h-4">
              </div>
              <div class="flex-1">
                <input type="text" id="saveLinkIconUrl"  class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors " placeholder="请输入图标地址">
              </div>
              <button type="button" onclick="getFavicon('saveLink')" class="px-4 py-2 bg-theme text-sm text-theme-secondary hover:text-theme rounded border border-theme transition-colors">获取图标</button>
            </div>
          </div>
        </div>
      </form>
      <div class="p-4 border-t border-theme flex justify-end space-x-2">
        <button type="button" onclick="closeLinkSaveModal()" class="px-6 py-2 text-sm bg-theme hover:bg-opacity-80 text-theme-secondary rounded transition-colors">取消</button>
        <button type="button" onclick="saveLink()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">保存</button>
      </div>
    </div>
  </div>

  <!-- 编辑弹框 -->
  <div id="editLinkModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[480px] relative">
      <div class="p-4 border-b border-theme flex justify-between items-center">
        <h2 class="text-base font-medium text-theme">编辑书签</h2>
        <button onclick="closeLinkEditModal()" class="text-theme-secondary hover:text-theme transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editLinkForm" class="p-6">
        <div class="space-y-4">
          <input type="hidden" id="editLinkId"></input>
          <div>
            <label class="block text-sm text-theme mb-1">名称</label>
            <input type="text" id="editLinkTitle" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入书签名称">
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">链接</label>
            <input type="url" id="editLinkUrl" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入链接地址">
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">描述</label>
            <textarea id="editLinkDescription" rows="3" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors resize-none" placeholder="请输入书签描述"></textarea>
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">分类</label>
            <select id="editLinkCategoryId" class="linkCategoryId w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors appearance-none"></select>
          </div>
          <div>
            <label class="block text-sm text-theme mb-1">图标</label>
            <div class="flex items-center space-x-2">
              <div  class="w-8 h-8 bg-theme rounded flex items-center justify-center">
                <img id="editLinkPreviewIcon" src="" alt="" class="w-4 h-4">
              </div>
              <div class="flex-1">
                <input type="text" id="editLinkIconUrl"  class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors " placeholder="请输入图标地址">
              </div>
              <button type="button" onclick="getFavicon('editLink')" class="px-4 py-2 bg-theme text-sm text-theme-secondary hover:text-theme rounded border border-theme transition-colors">获取图标</button>
            </div>
          </div>
        </div>
      </form>
      <div class="p-4 border-t border-theme flex justify-end space-x-2">
        <button type="button" onclick="closeLinkEditModal()" class="px-6 py-2 text-sm bg-theme hover:bg-opacity-80 text-theme-secondary rounded transition-colors">取消</button>
        <button type="button" onclick="editLink()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">保存</button>
      </div>
    </div>
  </div>

  <!-- 删除确认弹框 -->
  <div id="deleteLinkModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg p-6 w-[400px] relative">
      <button onclick="closeDeleteLinkModal()" class="absolute right-4 top-4 text-theme-secondary hover:text-purple-500 transition-colors">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="text-lg font-medium text-theme mb-4">确认删除</h2>
      <p class="text-theme-secondary mb-6">确定要删除这个链接吗？此操作无法撤销。</p>
      <span id="deleteLinkId" class="hidden"></span>
      <div class="flex justify-end space-x-3">
        <button onclick="closeDeleteLinkModal()" class="px-4 py-2 text-sm text-theme-secondary hover:text-theme transition-colors">取消</button>
        <button onclick="confirmDeleteLink()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded transition-colors">删除</button>
      </div>
    </div>
  </div>


  <!-- 分类管理弹框 -->
  <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[480px] relative">
      <div class="p-4 border-b border-theme flex justify-between items-center">
        <h2 class="text-base font-medium text-theme">分类管理</h2>
        <button onclick="closeSaveCategoryModal()" class="text-theme-secondary hover:text-theme transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="flex items-center space-x-2 mb-4">
          <input type="text" id="newCategory" class="flex-1 px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入分类名称">
          <button onclick="addCategory()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">添加</button>
        </div>
        <div class="space-y-2" id="categoryList">
          <!-- 分类列表将通过 JavaScript 动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 分类编辑弹框 -->
  <div id="editCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[400px] relative">
      <div class="p-4 border-b border-theme flex justify-between items-center">
        <h2 class="text-base font-medium text-theme">编辑分类</h2>
        <button onclick="closeEditCategoryModal()" class="text-theme-secondary hover:text-theme transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editCategoryForm" class="p-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-theme mb-1">分类名称</label>
            <input type="text" id="editCategoryName" class="w-full px-3 py-2 bg-theme border border-theme rounded text-sm text-theme focus:outline-none focus:border-purple-500 transition-colors" placeholder="请输入分类名称">
            <input type="hidden" id="categoryId">
          </div>
        </div>
      </form>
      <div class="p-4 border-t border-theme flex justify-end space-x-2">
        <button type="button" onclick="closeEditCategoryModal()" class="px-6 py-2 text-sm bg-theme hover:bg-opacity-80 text-theme-secondary rounded transition-colors">取消</button>
        <button type="button" onclick="updateCategory()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">保存</button>
      </div>
    </div>
  </div>

  <!-- 分类删除确认弹框 -->
  <div id="deleteCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-card-theme rounded-lg w-[400px] relative">
      <div class="p-4 border-b border-theme flex justify-between items-center">
        <h2 class="text-base font-medium text-theme">删除分类</h2>
        <button onclick="closeDeleteCategoryModal()" class="text-theme-secondary hover:text-theme transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="flex items-center space-x-3 text-yellow-500 mb-4">
          <i class="fas fa-exclamation-triangle text-xl"></i>
          <p class="text-sm text-theme">确定要删除该分类吗？删除后无法恢复。</p>
        </div>
        <div class="bg-theme rounded p-4">
          <p class="text-sm text-theme-secondary">分类名称：<span id="deleteCategoryName" class="text-theme"></span>
            <span id="deleteCategoryId" class="hidden"></span>
          </p>
        </div>
      </div>
      <div class="p-4 border-t border-theme flex justify-end space-x-2">
        <button type="button" onclick="closeDeleteCategoryModal()" class="px-6 py-2 text-sm bg-theme hover:bg-opacity-80 text-theme-secondary rounded transition-colors">取消</button>
        <button type="button" onclick="confirmDeleteCategory()" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded transition-colors">删除</button>
      </div>
    </div>
  </div>

  <script>

    $(document).ready(function() {

      // 主题切换功能
      const htmlElement = document.documentElement;
      // 检查本地存储中的主题设置
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        htmlElement.classList.remove('dark', 'light');
        htmlElement.classList.add(savedTheme);
        //切换主题图标
        toggleThemeIcon(savedTheme)
      }else{
        //设置默认主题
        toggleThemeIcon("light")
      }

      // 切换主题
      $('#themeToggle').on('click', function() {
        const isDark = htmlElement.classList.contains('dark');
        htmlElement.classList.remove('dark', 'light');
        const newTheme = isDark ? 'light' : 'dark';
        htmlElement.classList.add(newTheme);
        localStorage.setItem('theme', newTheme);

        //切换主题图标
        toggleThemeIcon(newTheme)
      });

      //搜索
      $('#searchInput, #mobileSearchInput').on('keydown', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
          handleSearch($(this).attr('id'));
        }
      });

      // 搜索图标点击事件
      $('.fa-search').on('click', function() {
        const inputId = $(this).closest('.relative').find('input').attr('id');
        handleSearch(inputId);
      });

      // 分类点击筛选
      $('nav button').on('click', function() {
        $('nav button').removeClass('bg-purple-500 text-white').addClass('text-theme-secondary');
        $(this).removeClass('text-theme-secondary').addClass('bg-purple-500 text-white');
      });

      // 修改登录按钮点击事件绑定
      $('#loginBtn').on('click', function(e) {
        e.preventDefault();
        openLoginModal();
      });

      // 确保所有关闭按钮都能正常工作
      $('.text-theme-secondary i.fa-times').parent().on('click', function() {
        closeLoginModal();
        closeRegisterModal();
      });

      // 点击模态框背景关闭
      $('#loginModal').on('click', function(e) {
        if (e.target === this) {
          closeLoginModal();
        }
      });

      // 添加移动端菜单控制
      $('#mobileMenuBtn').on('click', function() {
        $('#mobileMenu').addClass('active');
      });

      $('#closeMobileMenu').on('click', function() {
        $('#mobileMenu').removeClass('active');
      });


      // 点击移动端菜单外部关闭菜单
      $(document).on('click', function(e) {
        if (!$(e.target).closest('#mobileMenu, #mobileMenuBtn').length) {
          $('#mobileMenu').removeClass('active');
        }
      });
    });

    // 添加 ESC 键关闭功能
    $(document).on('keydown', function(e) {
      if (e.key === 'Escape') {
        closeLoginModal();
        closeRegisterModal();
      }
    });

    function toggleThemeIcon(theme){
      if (theme === 'dark') {
        $('#themeToggle').find('.fa-moon').removeClass('hidden');
        $('#themeToggle').find('.fa-sun').addClass('hidden');
      } else {
        $('#themeToggle').find('.fa-moon').addClass('hidden');
        $('#themeToggle').find('.fa-sun').removeClass('hidden');
      }
    }

    // 将handleSearch函数移到document.ready外部
    function handleSearch(inputId) {
      const keyword = $(`#${inputId}`).val().trim();
      if (keyword) {
        loadLinks(null, keyword);
        // 如果是移动端搜索，关闭移动菜单
        if (inputId === 'mobileSearchInput') {
          $('#mobileMenu').removeClass('active');
        }
      } else {
        toastr.warning('请输入搜索内容');
      }
    }

    initOp()
    //页面加载初始化操作
    function initOp(){
      // 无论是否登录，都加载共享链接分类
      loadCategories()
      
      // 默认显示共享链接
      loadSharedLinks()
      
      let userId=localStorage.getItem("userId")
      if(""!=userId&&undefined!=userId){
        if(isLogin()){
          // 登录成功后隐藏登录按钮，显示用户名
          $('#loginBtn').hide();
          $('#userInfo').removeClass('hidden').show();
          $('#usernameDisplay').text(localStorage.getItem("username"));
          //显示悬浮菜单
          $('#floatBtn').removeClass('hidden').show()
          // 重新加载分类（包括用户个人分类）
          loadCategories()
        }
      }
    }
    //页面初次加载操作
    function isLogin(){
      let result=false;
      $.ajax({
        url:"/api/user/isLogin",
        method:"get",
        dataType:"json",
        async: false,
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        success:function(res){
          if(res.code==0){
            result= res.data;
          }
        }
      })
      return result;
    }

    // 登录/注册相关函数
    function openLoginModal() {
      closeRegisterModal();
      $('#loginModal').removeClass('hidden').addClass('flex');
      // 防止背景滚动
      document.body.style.overflow = 'hidden';
    }

    function closeLoginModal() {
      $('#loginModal').removeClass('flex').addClass('hidden');
      $('#loginForm')[0].reset();
      // 恢复背景滚动
      document.body.style.overflow = '';
    }

    function togglePassword(button) {
      const input = $(button).siblings('input');
      const icon = $(button).find('i');
      if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
      } else {
        input.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
      }
    }

    function handleLogin() {
      const tel = $('#loginTel').val().trim();
      const password = $('#loginPassword').val().trim();
      const remember = $('#loginRemember').is(':checked');

      if (!tel || !password) {
        alert('请填写完整的登录信息');
        return;
      }

      // 这里添加登录的后端交互逻辑
      // console.log('登录信息：', { tel, password, remember });
      $.ajax({
        url:"/api/user/login",
        method:"post",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{tel:tel,password:password,remember},
        success:function(res){
          if(res.code==0){
            //登录成功
            toastr.success('登录成功')

            //用户名 和租户存在本地存储
            localStorage.setItem("userId",res.data.userId)
            localStorage.setItem("username",res.data.username)
            localStorage.setItem("tel",res.data.tel)
            localStorage.setItem("tenantId",res.data.tenantId)
            localStorage.setItem("token",res.data.token)

            // 登录成功后隐藏登录按钮，显示用户名
            $('#loginBtn').hide();
            $('#userInfo').removeClass('hidden').show();
            $('#usernameDisplay').text(localStorage.getItem("username"));
            //显示悬浮菜单
            $('#floatBtn').removeClass('hidden').show()

            //加载目录和书签
            loadCategories()

            closeLoginModal();
          }else{
            alert(res.msg)
          }
        }

      })
    }

    function handleLogout(){
      $.ajax({
        url:"/api/user/logout",
        method:"post",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{userId:localStorage.getItem("userId")},
        success:function(res){
          if(res.code==0){
            toastr.success('退出成功')
            //清空本地存储
            localStorage.removeItem("userId")
            localStorage.removeItem("username")
            localStorage.removeItem("tel")
            localStorage.removeItem("tenantId")
            localStorage.removeItem("token")

            // 退出登录逻辑
            $('#userInfo').hide();
            $('#loginBtn').show();
            $('#usernameDisplay').text('');

            window.location="/"


          }else{
            toastr.error(res.msg)
          }
        }
      })
    }

    function openRegisterModal() {
      closeLoginModal();
      $('#registerModal').removeClass('hidden').addClass('flex');
    }

    function closeRegisterModal() {
      $('#registerModal').removeClass('flex').addClass('hidden');
      $('#registerForm')[0].reset();
    }
    // 验证码倒计时功能
    let registerCodeTimer = null;
    let registerCodeCountdown = 60;
    function sendRegisterCode() {
      const phone = $('#registerForm input[type="tel"]').val().trim();
      if (!phone) {
        alert('请输入手机号');
        return;
      }
      // 禁用按钮并开始倒计时
      $('#sendRegisterCodeBtn').prop('disabled', true).text(`已发送(${registerCodeCountdown}s)`);
      registerCodeTimer = setInterval(() => {
        registerCodeCountdown--;
        if (registerCodeCountdown > 0) {
          $('#sendRegisterCodeBtn').text(`已发送(${registerCodeCountdown})`);
        } else {
          clearInterval(registerCodeTimer);
          $('#sendRegisterCodeBtn').prop('disabled', false).text('发送验证码');
          registerCodeCountdown = 60;
        }
      }, 1000);

      // 这里添加发送验证码的后端交互逻辑
      $.ajax({
        url:"/api/sms/register",
        method:"get",
        dataType:"json",
        data:{phone:phone},
        success:function(res){
          if(res.code==0){
            toastr.success("验证码发送成功")
          }else{
            toastr.error(res.msg)
            // 如果失败，立即恢复按钮
            clearInterval(registerCodeTimer);
            $('#sendRegisterCodeBtn').prop('disabled', false).text('发送验证码');
            registerCodeCountdown = 60;
          }
        }
      })
    }

    function handleRegister() {
      const tel = $('#registerTel').val().trim();
      const code = $('#registerCode').val().trim();
      const password = $('#registerPassword').eq(0).val().trim();
      const confirmPassword = $('#registerConfirmPassword').eq(1).val().trim();
      const agreement = $('#registerAgreement').is(':checked');

      if (!tel ||!code|| !password || !confirmPassword) {
        alert('请填写完整的注册信息');
        return;
      }

      if (password !== confirmPassword) {
        alert('两次输入的密码不一致');
        return;
      }

      if (!agreement) {
        alert('请阅读并同意服务条款和隐私政策');
        return;
      }

      // 这里添加注册的后端交互逻辑
      $.ajax({
        url:"/api/user/register",
        method:"post",
        dataType:"json",//服务器返回结果
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{tel:tel,code:code,password:password},
        success:function (res) {
          if(res.code==0){
            //注册成功
            toastr.success("注册成功")
            closeRegisterModal();
            openLoginModal(); // 注册成功后跳转到登录
          }else{
            //注册失败
            toastr.error(res.msg)
          }
        }
      })
    }

    function switchToLogin() {
      closeRegisterModal();
      openLoginModal();
    }

    function openForgotPasswordModal() {
      closeLoginModal();
      $('#forgotPasswordModal').removeClass('hidden').addClass('flex');
    }

    function closeForgotPasswordModal() {
      $('#forgotPasswordModal').removeClass('flex').addClass('hidden');
      $('#forgotPasswordForm')[0].reset();
    }

    // 验证码倒计时功能
    let forgotCodeTimer = null;
    let forgotCodeCountdown = 60;
    function sendForgotCode() {
      const phone = $('#forgotPhone').val().trim();
      console.log(phone)
      if (!phone) {
        alert('请输入手机号');
        return;
      }
      // 禁用按钮并开始倒计时
      $('#sendForgotCodeBtn').prop('disabled', true).text(`已发送(${forgotCodeCountdown}s)`);
      forgotCodeTimer = setInterval(() => {
        forgotCodeCountdown--;
        if (forgotCodeCountdown > 0) {
          $('#sendForgotCodeBtn').text(`已发送(${forgotCodeCountdown}s)`);
        } else {
          clearInterval(forgotCodeTimer);
          $('#sendForgotCodeBtn').prop('disabled', false).text('发送验证码');
          forgotCodeCountdown = 60;
        }
      }, 1000);

      // 这里添加发送验证码的后端交互逻辑
      $.ajax({
        url:"/api/sms/forgotPassword",
        method:"get",
        dataType:"json",
        data:{phone:phone},
        success:function(res){
          if(res.code==0){
            toastr.success("验证码发送成功")
          }else{
            toastr.error(res.msg)
            // 如果失败，立即恢复按钮
            clearInterval(forgotCodeTimer);
            $('#sendForgotCodeBtn').prop('disabled', false).text('发送验证码');
            forgotCodeCountdown = 60;
          }
        }
      })
    }

    function handleForgotPassword() {
      const phone = $('#forgotPhone').val().trim();
      const code = $('#forgotCode').val().trim();
      const newPassword = $('#forgotNewPassword').val().trim();
      if (!phone || !code || !newPassword) {
        alert('请填写完整信息');
        return;
      }

      // 这里添加重置密码的后端交互逻辑
      $.ajax({
        url:"/api/user/findPassword",
        method:"post",
        dataType:"json",
        data:{phone:phone,code:code,newPassword:newPassword},
        success:function(res){
          if(res.code==0){
            toastr.success("重置密码成功")
            closeForgotPasswordModal();
            openLoginModal();
          }else{
            toastr.error(res.msg)
          }
        }
      })

    }


    // 链接相关JS

    //根据域名获取icon图标地址
    function getFavicon(target) {
      let linkUrl = $("#"+target+"Url").val();
      if(!linkUrl)return;
      if (linkUrl.startsWith('http://') || linkUrl.startsWith('https://')) {
        linkUrl = new URL(linkUrl).hostname;
      }

      //待确定
      //ttps://xxapi.cn/doc/ico
      //https://www.favicon.vip/
      let iconUrl= `https://icon.bqb.cool?url=${linkUrl}`;

      $("#"+target+"IconUrl").val(iconUrl);
      //预览图标
      $("#"+target+"PreviewIcon").attr("src",iconUrl)
    }

    // 打开保存书签弹框
    function openLinkSaveModal(linkId) {
      // 重置表单
      $('#saveLinkId').val('');
      $('#saveLinkTitle').val('');
      $('#saveLinkDescription').val('');
      $('#saveLinkIconUrl').val('');
      $('#saveLinkUrl').val('');
      $('#saveLinkCategoryId').val('');
      $('#saveLinkPreviewIcon').attr("src","");

      //新增
      $('#saveLinkModal').removeClass('hidden').addClass('flex');
    }

    // 关闭保存书签弹框
    function closeLinkSaveModal() {
      $('#saveLinkModal').removeClass('flex').addClass('hidden');
    }

    function saveLink() {
      const title = $('#saveLinkTitle').val().trim();
      const url = $('#saveLinkUrl').val().trim();
      const description = $('#saveLinkDescription').val().trim();
      const categoryId = $('#saveLinkCategoryId').val();
      const iconUrl = $('#saveLinkIconUrl').val().trim();

      if (!title) {
        alert('请输入书签名称');
        return;
      }

      if (!url) {
        alert('请输入链接地址');
        return;
      }
      if (!categoryId) {
        alert('请选择所属分类');
        return;
      }


      $.ajax({
        url:"/api/link",
        method:"post",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{title:title,url:url,description:description,iconUrl:iconUrl,categoryId:categoryId},
        success:function(res){
          if(res.code==0){
            toastr.success("保存成功")
            loadCategories()
          }else{
            toastr.error(res.msg)
          }
        }
      })

      closeLinkSaveModal();
    }

    // 打开编辑书签弹框
    function openLinkEditModal(linkId) {

      // 重置表单
      $('#editLinkId').val('');
      $('#editLinkTitle').val('');
      $('#editLinkDescription').val('');
      $('#editLinkUrl').val('');
      $('#editLinkCategoryId').val('');
      $('#editLinkIconUrl').val('');
      $('#editLinkPreviewIcon').attr("src","");

      //编辑
      $.ajax({
        url:"/api/link/getById",
        method:"get",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{linkId:linkId},
        success:function(res){
          if(res.code==0){
            $('#editLinkId').val(res.data.linkId);
            $('#editLinkTitle').val(res.data.title);
            $('#editLinkUrl').val(res.data.url);
            $('#editLinkDescription').val(res.data.description);
            $('#editLinkCategoryId').val(res.data.categoryId);
            $('#editLinkIconUrl').val(res.data.iconUrl);
            $('#editLinkPreviewIcon').attr('src',res.data.iconUrl).show();

          }else{
            toastr.error(res.msg)
          }
        }
      })

      //新增
      $('#editLinkModal').removeClass('hidden').addClass('flex');
    }

    // 关闭编辑书签弹框
    function closeLinkEditModal() {
      $('#editLinkModal').removeClass('flex').addClass('hidden');
    }

    // 保存编辑
    function editLink() {
      const linkId = $('#editLinkId').val().trim();
      const title = $('#editLinkTitle').val().trim();
      const url = $('#editLinkUrl').val().trim();
      const description = $('#editLinkDescription').val().trim();
      const categoryId = $('#editLinkCategoryId').val();
      const iconUrl = $('#editLinkIconUrl').val().trim();

      if (!title) {
        alert('请输入书签名称');
        return;
      }

      if (!url) {
        alert('请输入链接地址');
        return;
      }
      if (!categoryId) {
        alert('请选择所属分类');
        return;
      }

      $.ajax({
        url:"/api/link",
        method:"put",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{linkId:linkId,title:title,url:url,description:description,iconUrl:iconUrl,categoryId:categoryId},
        success:function(res){
          if(res.code==0){
            toastr.success("保存成功")
            loadCategories()
            closeLinkEditModal();
          }else{
            toastr.error(res.msg)
          }
        }
      })


    }

    // 打开删除确认弹框
    function openDeleteLinkModal(linkId) {
      $("#deleteLinkId").text(linkId)
      $('#deleteLinkModal').removeClass('hidden').addClass('flex');
    }

    // 关闭删除确认弹框
    function closeDeleteLinkModal() {
      $("#deleteLinkId").empty()
      $('#deleteLinkModal').removeClass('flex').addClass('hidden');
    }

    // 确认删除
    function confirmDeleteLink() {

      let deleteLinkId= $("#deleteLinkId").text()
      $.ajax({
        url:"/api/link",
        method:"delete",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{linkId:deleteLinkId},
        success:function(res){
          if(res.code==0){
            toastr.success("删除成功")
            loadCategories()

            closeDeleteLinkModal();
          }else{
            toastr.error(res.msg)
          }
        }
      })
    }
    // Sortable实例
    let sortableInstance = null;

    //加载书签数据
    function loadLinks(categoryId,linkTitle=''){
      $.ajax({
        url:"/api/link/list",
        method:"get",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{categoryId:categoryId,linkTitle:linkTitle},
        success:function(res){
          const linkList=$("#linkList")
          linkList.empty()

          // 销毁旧的Sortable实例
          if(sortableInstance){
            sortableInstance.destroy();
            sortableInstance = null;
          }

          if(res.code==0){
            res.data.forEach(link=>{
              const isShared = link.isShared === '1';
              linkList.append(`
                  <div data-link-id="${link.linkId}" class="link-card bg-card-theme rounded-lg p-3 hover:ring-1 hover:ring-purple-500 transition-all duration-200 card-shadow">
                   <div class="flex items-start justify-between mb-2">
                       <div class="flex items-center space-x-2">
                         <div class="w-8 h-8 bg-theme rounded flex items-center justify-center">
                           <img  src="${link.iconUrl}" class="w-6 h-6">
                         </div>
                         <a href="javascript:void(0)"  onclick="openLink('${link.url}')"><h3  class="text-sm font-medium text-theme hover:cursor-pointer">${link.title}</h3></a>
                       </div>
                       <div class="flex items-center space-x-1">
                        <button class="text-theme-secondary hover:text-purple-500 transition-colors p-1.5 rounded-full hover:bg-theme" onclick="openLinkEditModal('${link.linkId}')" title="编辑">
                          <i class="fas fa-edit text-sm"></i>
                        </button>
                        <button class="text-theme-secondary hover:text-red-500 transition-colors p-1.5 rounded-full hover:bg-theme" onclick="openDeleteLinkModal('${link.linkId}')" title="删除">
                          <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                                                <button class="text-theme-secondary hover:text-green-500 transition-colors p-1.5 rounded-full hover:bg-theme" 
                          onclick="${isShared ? "unshareLink" : "shareLink"}('${link.linkId}')" 
                          title="${isShared ? "取消共享" : "共享链接"}">
                          <i class="fas fa-${isShared ? "share-alt" : "share"} text-sm"></i>
                        </button>
                       </div>
                   </div>
                   <p class="text-xs text-theme-secondary line-clamp-2">${link.description}</p>
                   ${isShared ? "<div class=\"mt-2 text-xs text-green-500\"><i class=\"fas fa-check-circle mr-1\"></i>已共享</div>" : ""}
                 </div>
              `)
            })
            
            // 初始化拖拽排序（仅在用户登录、不是共享链接页面、且不是搜索时启用）
            const userId = localStorage.getItem("userId");
            if(userId && userId !== "" && userId !== "undefined" && categoryId !== null && categoryId !== 'shared' && !linkTitle){
              initSortable(categoryId);
            }
          }else{
            toastr.error(res.msg)
          }
        }
      })
    }

    // 初始化拖拽排序功能
    function initSortable(categoryId) {
      const linkList = document.getElementById('linkList');
      if (!linkList || sortableInstance) {
        return;
      }

      sortableInstance = new Sortable(linkList, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        handle: '.link-card', // 整个卡片都可以拖拽
        onEnd: function(evt) {
          // 拖拽结束后保存新的顺序
          saveLinkOrder(categoryId);
        }
      });
    }

    // 保存链接排序
    function saveLinkOrder(categoryId) {
      const linkCards = $('#linkList .link-card');
      const linkIds = [];
      
      linkCards.each(function() {
        const linkId = $(this).data('link-id');
        if(linkId) {
          linkIds.push(linkId);
        }
      });

      if(linkIds.length === 0) {
        return;
      }

      // 调用后端API保存排序
      $.ajax({
        url: "/api/link/sort",
        method: "post",
        dataType: "json",
        headers: {'TENANT-ID': localStorage.getItem("tenantId")},
        data: {
          categoryId: categoryId,
          linkIds: JSON.stringify(linkIds)
        },
        success: function(res) {
          if(res.code == 0) {
            toastr.success("排序已保存");
          } else {
            toastr.error(res.msg || "保存排序失败");
          }
        },
        error: function() {
          toastr.error("保存排序失败，请稍后重试");
        }
      });
    }

    //书签点击打开链接
    function openLink(linkUrl){
      if(!linkUrl) {
        return;
      }
      if(!linkUrl.startsWith("http://") && !linkUrl.startsWith("https://")){
        linkUrl = "http://" + linkUrl;
      }
      window.open(linkUrl, "_blank");
    }


    // 分类管理相关函数


    function openSaveCategoryModal() {
      loadCategories();
      $('#categoryModal').removeClass('hidden').addClass('flex');
    }

    function closeSaveCategoryModal() {
      $('#categoryModal').removeClass('flex').addClass('hidden');
    }
    function addCategory() {
      const newCategory = $('#newCategory').val().trim();
      if (!newCategory) {
        alert('请输入分类名称');
        return;
      }

      // 这里后端的交互逻辑
      $.ajax({
        url:"/api/category",
        method:"post",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{name:newCategory},
        success:function(res){
          if(res.code==0){
            toastr.success("添加成功")

            $('#newCategory').val('');
            loadCategories();
          }else{
            toastr.error(res.msg)
          }
        }
      })

    }



    function openEditCategoryModal(categoryId,categoryName) {
      $('#categoryId').val(categoryId);
      $('#editCategoryName').val(categoryName);
      $('#editCategoryModal').removeClass('hidden').addClass('flex');
    }

    function closeEditCategoryModal() {
      $('#editCategoryModal').removeClass('flex').addClass('hidden');
    }

    function updateCategory() {
      const newName = $('#editCategoryName').val().trim();
      const categoryId = $('#categoryId').val();
      
      if (!newName) {
        alert('请输入分类名称');
        return;
      }

      // 这里应该添加与后端的交互逻辑
      $.ajax({
        url:"/api/category",
        method:"put",
        dataType:'json',
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{categoryId:categoryId,name:newName},
        success:function(res){
          if(res.code==0){
            toastr.success("修改成功")

            closeEditCategoryModal();
            loadCategories(); // 重新加载分类列表
          }else{
            toastr.error(res.msg)
          }
        }
      })
      

    }

    function openDeleteCategoryModal(categoryId,categoryName) {
      $('#deleteCategoryId').text(categoryId);
      $('#deleteCategoryName').text(categoryName);
      $('#deleteCategoryModal').removeClass('hidden').addClass('flex');
    }

    function closeDeleteCategoryModal() {
      $('#deleteCategoryModal').removeClass('flex').addClass('hidden');
    }

    function confirmDeleteCategory() {

      const categoryId=$("#deleteCategoryId").text()

      // 这里应该添加与后端的交互逻辑
      $.ajax({
        url:"/api/category",
        method:"delete",
        dataType:"json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data:{categoryId:categoryId},
        success:function(res){
          if(res.code==0){
            toastr.success("删除成功")

            closeDeleteCategoryModal();
            loadCategories(); // 重新加载分类列表
          }else{
            toastr.error("删除失败")
          }
        }
      })

    }


    // 修改 loadCategories 函数中的分类项模板
    function loadCategories() {
      let categories = [];

      // 添加共享链接分类（写死在前端，始终显示）
      const sharedCategory = {
        categoryId: 'shared',
        name: '共享链接'
      };

      //生成横向导航（桌面端）
      const navList = $('#navList');
      navList.empty();
      
      // 先添加共享链接分类
      navList.append(`
        <button onclick="loadSharedLinks()" class="px-4 py-1.5 text-sm text-theme-secondary hover:bg-card-theme rounded transition-colors whitespace-nowrap hover:cursor-pointer">
          <i class="fas fa-share-alt mr-1"></i>${sharedCategory.name}
        </button>
      `);

      // 尝试加载用户分类（仅在登录状态下）
      let userId = localStorage.getItem("userId");
      if (userId && userId !== "" && userId !== "undefined") {
        $.ajax({
          url: "/api/category/list",
          method: "get",
          dataType: "json",
          data: "json",
          async: false,
          headers:{'TENANT-ID':localStorage.getItem("tenantId")},
          success: function(res) {
            if (res.code == 0) {
              res.data.forEach(u => categories.push(u));
              //加载书签数据
              if(categories.length>0){
                loadLinks(categories[0].categoryId);
              }
            } else {
              console.log("加载用户分类失败，但共享链接分类仍可正常使用");
            }
          },
          error: function() {
            console.log("加载用户分类失败，但共享链接分类仍可正常使用");
          }
        });
      }
      
      // 再添加其他分类
      categories.forEach(category => {
        navList.append(`
          <button onclick="loadLinks('${category.categoryId}')" class="px-4 py-1.5 text-sm text-theme-secondary hover:bg-card-theme rounded transition-colors whitespace-nowrap hover:cursor-pointer">${category.name}</button>
        `);
      });

      //生成移动端导航菜单
      const mobileNavList = $('#mobileNavList');
      mobileNavList.empty();
      
      // 先添加共享链接分类
      mobileNavList.append(`
        <button onclick="loadSharedLinks(); $('#mobileMenu').removeClass('active');" 
          class="w-full px-4 py-2 text-sm text-theme-secondary hover:bg-theme rounded transition-colors text-left">
          <i class="fas fa-share-alt mr-1"></i>${sharedCategory.name}
        </button>
      `);
      
      // 再添加其他分类
      categories.forEach(category => {
        mobileNavList.append(`
          <button onclick="loadLinks('${category.categoryId}'); $('#mobileMenu').removeClass('active');"
            class="w-full px-4 py-2 text-sm text-theme-secondary hover:bg-theme rounded transition-colors text-left">
            ${category.name}
          </button>
        `);
      });

      //生成书签选择目录列表
      const selectCategoryList = $(".linkCategoryId");
      selectCategoryList.empty();
      categories.forEach(category => {
        selectCategoryList.append(`
          <option value="${category.categoryId}">${category.name}</option>
        `);
      });

      //生成目录列表
      const categoryList = $('#categoryList');
      categoryList.empty();
      categories.forEach(category => {
        categoryList.append(`
          <div class="flex items-center justify-between p-3 bg-theme rounded group">
            <span class="text-sm text-theme">${category.name}</span>
            <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="text-theme-secondary hover:text-blue-500 transition-colors p-1.5 hover:bg-black hover:bg-opacity-10 rounded" 
                onclick="openEditCategoryModal('${category.categoryId}','${category.name}')" title="编辑分类">
                <i class="fas fa-edit"></i>
              </button>
              <button class="text-theme-secondary hover:text-red-500 transition-colors p-1.5 hover:bg-black hover:bg-opacity-10 rounded" 
                onclick="openDeleteCategoryModal('${category.categoryId}','${category.name}')" title="删除分类">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        `);
      });
    }

    // 加载共享链接
    function loadSharedLinks() {
      $.ajax({
        url: "/api/link/shared",
        method: "get",
        dataType: "json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        success: function(res) {
          const linkList = $("#linkList");
          linkList.empty();

          // 销毁Sortable实例（共享链接不支持拖拽排序）
          if(sortableInstance){
            sortableInstance.destroy();
            sortableInstance = null;
          }

          if (res.code == 0) {
            if (res.data.length === 0) {
              linkList.append(`
                <div class="col-span-full text-center py-8">
                  <i class="fas fa-share-alt text-4xl text-theme-secondary mb-4"></i>
                  <p class="text-theme-secondary">暂无共享链接</p>
                </div>
              `);
            } else {
              res.data.forEach(link => {
                linkList.append(`
                  <div class="bg-card-theme rounded-lg p-3 hover:ring-1 hover:ring-purple-500 transition-all duration-200 card-shadow">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-theme rounded flex items-center justify-center">
                          <img src="${link.iconUrl}" class="w-6 h-6">
                        </div>
                        <a href="javascript:void(0)" onclick="openLink('${link.url}')">
                          <h3 class="text-sm font-medium text-theme hover:cursor-pointer">${link.title}</h3>
                        </a>
                      </div>
                      <div class="flex items-center space-x-1">
                        <button class="text-theme-secondary hover:text-green-500 transition-colors p-1.5 rounded-full hover:bg-theme" 
                          onclick="copySharedLink('${link.linkId}')" title="复制到我的分类">
                          <i class="fas fa-copy text-sm"></i>
                        </button>
                      </div>
                    </div>
                    <p class="text-xs text-theme-secondary line-clamp-2">${link.description}</p>
                    <div class="flex items-center justify-between mt-2 text-xs text-theme-secondary">
                      <span>来自: ${link.createBy || "未知用户"}</span>
                      <span>共享时间: ${link.sharedTime ? new Date(link.sharedTime).toLocaleDateString() : "未知"}</span>
                    </div>
                  </div>
                `);
              });
            }
          } else {
            toastr.error("加载共享链接失败");
          }
        }
      });
    }

    // 复制共享链接到个人分类
    function copySharedLink(sharedLinkId) {
      // 获取当前用户信息
      const currentUsername = localStorage.getItem("username");
      if (!currentUsername) {
        toastr.error("请先登录");
        return;
      }
      
      // 获取共享链接信息，检查是否已经属于当前用户
      $.ajax({
        url: "/api/link/getById",
        method: "get",
        data: { linkId: sharedLinkId },
        dataType: "json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        success: function(res) {
          if (res.code == 0) {
            const link = res.data;
            // 检查链接是否已经属于当前用户
            if (link.createBy === currentUsername) {
              toastr.warning("该链接已经属于您，无需重复复制");
              return;
            }
            
            // 如果链接不属于当前用户，则继续复制流程
            loadUserCategoriesForCopy(sharedLinkId);
          } else {
            toastr.error("获取链接信息失败");
          }
        },
        error: function() {
          toastr.error("网络错误，请稍后重试");
        }
      });
    }
    
    // 加载用户分类用于复制
    function loadUserCategoriesForCopy(sharedLinkId) {
      // 获取用户分类列表
      $.ajax({
        url: "/api/category/list",
        method: "get",
        dataType: "json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        success: function(res) {
          if (res.code == 0 && res.data.length > 0) {
            // 弹出选择分类的对话框
            showCopyCategoryModal(sharedLinkId, res.data);
          } else {
            toastr.error("请先创建分类");
          }
        }
      });
    }

    // 显示复制分类选择对话框
    function showCopyCategoryModal(sharedLinkId, categories) {
      let modalHtml = `
        <div id="copyCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-card-theme rounded-lg w-[400px] relative">
            <div class="p-4 border-b border-theme flex justify-between items-center">
              <h2 class="text-base font-medium text-theme">选择目标分类</h2>
              <button onclick="closeCopyCategoryModal()" class="text-theme-secondary hover:text-theme transition-colors">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="p-6">
              <p class="text-sm text-theme-secondary mb-4">请选择要将链接复制到哪个分类：</p>
              <div class="space-y-2" id="categoryOptions">`;
      
      categories.forEach((category, index) => {
        modalHtml += `
          <button onclick="selectCategory('${category.categoryId}', this)" 
            class="category-option w-full px-4 py-2 text-sm text-theme bg-theme border border-theme rounded hover:border-purple-500 transition-colors text-left"
            data-category-id="${category.categoryId}">
            ${category.name}
          </button>`;
      });
      
      modalHtml += `
              </div>
              <div class="mt-6 flex justify-end">
                <button onclick="confirmCopySharedLink('${sharedLinkId}')" 
                  id="confirmBtn"
                  class="px-6 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
                  确认复制
                </button>
              </div>
            </div>
          </div>
        </div>`;
      
      $('body').append(modalHtml);
    }

    // 关闭复制分类选择对话框
    function closeCopyCategoryModal() {
      // 清理选中的分类ID
      $('#copyCategoryModal').removeData('selected-category-id');
      $('#copyCategoryModal').remove();
    }

    // 选择分类
    function selectCategory(categoryId, element) {
      // 移除所有分类的选中样式
      $('.category-option').removeClass('bg-purple-500 text-white border-purple-500').addClass('bg-theme text-theme border-theme');
      
      // 给当前选中的分类添加样式
      $(element).removeClass('bg-theme text-theme border-theme').addClass('bg-purple-500 text-white border-purple-500');
      
      // 启用确认按钮
      $('#confirmBtn').prop('disabled', false);
      
      // 存储选中的分类ID
      $('#copyCategoryModal').data('selected-category-id', categoryId);
    }

    // 确认复制共享链接
    function confirmCopySharedLink(sharedLinkId) {
      const targetCategoryId = $('#copyCategoryModal').data('selected-category-id');
      
      if (!targetCategoryId) {
        toastr.warning('请先选择一个分类');
        return;
      }
      
      $.ajax({
        url: "/api/link/copy",
        method: "post",
        dataType: "json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data: {
          sharedLinkId: sharedLinkId,
          targetCategoryId: targetCategoryId
        },
        success: function(res) {
          if (res.code == 0) {
            toastr.success("复制成功！链接已添加到您的分类中");
            closeCopyCategoryModal();
          } else {
            // 根据不同的错误情况显示不同的提示
            if (res.msg && res.msg.includes("已经属于您")) {
              toastr.warning(res.msg);
            } else {
              toastr.error(res.msg || "复制失败");
            }
          }
        },
        error: function() {
          toastr.error("网络错误，请稍后重试");
        }
      });
    }

    // 共享链接
    function shareLink(linkId) {
      $.ajax({
        url: "/api/link/share",
        method: "post",
        dataType: "json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data: { linkId: linkId },
        success: function(res) {
          if (res.code == 0) {
            toastr.success("共享成功！");
            // 重新加载当前分类的链接
            const currentCategoryId = $('.linkCategoryId').val();
            if (currentCategoryId) {
              loadLinks(currentCategoryId);
            }
          } else {
            toastr.error(res.msg || "共享失败");
          }
        }
      });
    }

    // 取消共享链接
    function unshareLink(linkId) {
      $.ajax({
        url: "/api/link/unshare",
        method: "post",
        dataType: "json",
        headers:{'TENANT-ID':localStorage.getItem("tenantId")},
        data: { linkId: linkId },
        success: function(res) {
          if (res.code == 0) {
            toastr.success("已取消共享");
            // 重新加载当前分类的链接
            const currentCategoryId = $('.linkCategoryId').val();
            if (currentCategoryId) {
              loadLinks(currentCategoryId);
            }
          } else {
            toastr.error(res.msg || "取消共享失败");
          }
        }
      });
    }



  </script>
</body>
</html> 